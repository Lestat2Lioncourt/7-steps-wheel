<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roue CSI - Identification</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

<div class="accueil-container">
    <h1 class="accueil-title">Identification</h1>

    {% if error %}
    <p style="color:#dc2626;font-size:13px">{{ error }}</p>
    {% endif %}

    {% if accounts and accounts|length > 1 %}
    {# Plusieurs comptes O365 detectes — choix #}
    <p class="accueil-subtitle">Plusieurs comptes O365 detectes sur ce poste</p>
    <p class="accueil-subtitle">Selectionnez le compte a utiliser</p>
    <div class="project-cards">
        {% for acc in accounts %}
        <form method="POST" style="display:contents">
            <input type="hidden" name="email" value="{{ acc.email }}">
            <input type="hidden" name="nom" value="{{ acc.nom }}">
            <input type="hidden" name="trigramme" value="">
            <button type="submit" class="project-card" style="border:none;text-align:center">
                <div class="project-card-name" style="font-size:14px">{{ acc.nom }}</div>
                <div class="project-card-file">{{ acc.email }}</div>
                <div class="project-card-btn">Utiliser ce compte</div>
            </button>
        </form>
        {% endfor %}
    </div>

    {% else %}
    {# Aucun compte detecte — formulaire manuel #}
    <p class="accueil-subtitle">Votre identite Windows n'a pas pu etre detectee automatiquement.</p>
    <p class="accueil-subtitle">Saisissez vos informations pour continuer</p>

    <form method="POST" class="login-form">
        <div class="login-field">
            <label for="email">Email O365</label>
            <input type="email" id="email" name="email"
                   value="{{ prefill.email or '' }}"
                   placeholder="prenom.nom@entreprise.com" required>
        </div>
        <div class="login-field">
            <label for="nom">Nom affiche</label>
            <input type="text" id="nom" name="nom"
                   value="{{ prefill.nom or '' }}"
                   placeholder="NOM, Prenom" required>
        </div>
        <div class="login-field">
            <label for="trigramme">Trigramme</label>
            <input type="text" id="trigramme" name="trigramme"
                   value="{{ prefill.trigramme or '' }}"
                   placeholder="ABC" maxlength="4"
                   style="text-transform:uppercase;width:80px;letter-spacing:2px;font-weight:700;text-align:center">
            <span style="font-size:10px;color:#555;margin-left:6px">Auto-suggere depuis le nom</span>
        </div>
        <button type="submit" class="project-card-btn" style="margin-top:12px;padding:10px 32px;font-size:14px;border:none;border-radius:8px;cursor:pointer">
            Confirmer
        </button>
    </form>

    <script>
    (function() {
        var nomInput = document.getElementById('nom');
        var triInput = document.getElementById('trigramme');
        if (!nomInput || !triInput) return;
        var userEdited = false;
        triInput.addEventListener('input', function() { userEdited = true; });

        nomInput.addEventListener('input', function() {
            if (userEdited) return;
            var nom = nomInput.value.trim();
            if (!nom) { triInput.value = ''; return; }
            fetch('/api/trigramme/suggest?nom=' + encodeURIComponent(nom))
                .then(function(r) { return r.json(); })
                .then(function(d) { if (!userEdited) triInput.value = d.trigramme; });
        });

        if (nomInput.value.trim() && !triInput.value) {
            nomInput.dispatchEvent(new Event('input'));
        }
    })();
    </script>
    {% endif %}
</div>

</body>
</html>
