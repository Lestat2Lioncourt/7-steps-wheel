{% extends "base.html" %}

{% block title %}Roue CSI - {{ data.indicateur.code }}{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('main.vue_globale') }}">Global</a>
<span class="sep"> &rsaquo; </span>
<a href="{{ url_for('main.vue_categorie', id=data.categorie.id) }}">{{ data.categorie.nom }}</a>
<span class="sep"> &rsaquo; </span>
<span class="current">{{ data.indicateur.code }}</span>
{% endblock %}

{% block sidebar %}
<div class="sidebar-section">
    <h4>Categories</h4>
    {% for cat in data.categories %}
    <a class="sidebar-item" href="{{ url_for('main.vue_categorie', id=cat.id) }}">
        <span class="sidebar-dot" style="background:{{ COL[cat.worst] }}"></span>
        <span>{{ cat.nom }}</span>
    </a>
    {% endfor %}
</div>
<div class="sidebar-divider"></div>
<div class="sidebar-section">
    <h4>Indicateurs</h4>
    {% for sib in data.siblings %}
    <a class="sidebar-item{% if sib.id == data.indicateur.id %} active{% endif %}"
       href="{{ url_for('main.vue_indicateur', id=sib.id) }}"
       title="{{ sib.code }} : {{ sib.description }}">
        <span class="sidebar-dot" style="background:{{ COL[sib.worst] }}"></span>
        <span style="font-size:10px">{{ sib.code }}</span>
    </a>
    {% endfor %}
</div>
{% endblock %}

{% set ind = data.indicateur %}
{% set type_class = 'fb-sla' if ind.type == 'SLA' else ('fb-kpi' if ind.type == 'KPI' else 'fb-xla') %}

{% block fiche_panel %}
<div class="fiche-panel">
    <div class="fiche-inner">
        <div class="fiche-title">{{ ind.code }}</div>
        <div class="fiche-desc">{{ ind.description }}</div>
        <div class="fiche-badges">
            <span class="fiche-badge {{ type_class }}">{{ ind.type }}</span>
            <span class="fiche-badge fb-etat">{{ ind.etat }}</span>
            <span class="fiche-badge" style="background:{{ COL[ind.worst] }}20;color:{{ COL[ind.worst] }};border:1px solid {{ COL[ind.worst] }}40">{{ COL_LABEL[ind.worst] }}</span>
        </div>
        <div class="fiche-field">
            <label>Chapitre</label>
            <div class="val">{{ ind.chapitre }}</div>
        </div>
        <div class="fiche-field">
            <label>Categorie</label>
            <div class="val">{{ data.categorie.nom }}</div>
        </div>
        <div class="fiche-field">
            <label>Proprietes
                {% if session.get('user_role') != 'lecteur' %}
                <span class="fiche-edit-icon" onclick="openPropertiesModal({{ ind.id }})" title="Editer">&#9998;</span>
                {% endif %}
            </label>
            <div class="val-box" style="display:flex;flex-direction:column;gap:3px;font-size:12px">
                <div><span style="color:#888">Periodicite :</span> {{ ind.periodicite or 'Mensuel' }}</div>
                <div><span style="color:#888">SLA :</span> {% if ind.sla_valeur is not none %}{{ (ind.sla_valeur * 100)|round(1) }}%{% else %}<span style="color:#555;font-style:italic">-</span>{% endif %}</div>
                <div><span style="color:#888">KPI :</span> {% if ind.kpi_formule %}{{ ind.kpi_formule }}{% else %}<span style="color:#555;font-style:italic">-</span>{% endif %}</div>
                <div><span style="color:#888">Penalite :</span> {% if ind.penalite %}Oui{% else %}Non{% endif %}</div>
                <div><span style="color:#888">Seuil :</span> {% if ind.seuil is not none %}<span id="fiche-seuil-display">{{ ind.seuil }}s</span>{% else %}<span style="color:#555;font-style:italic">-</span>{% endif %}</div>
            </div>
        </div>
        {% set rc = ind.resolved.ciblage_fonctionnel %}
        {% set rct = ind.resolved.ciblage_technique %}
        <div class="fiche-field">
            <label>Condition de ciblage
                {% if session.get('user_role') != 'lecteur' %}
                <span class="fiche-edit-icon" onclick="openCiblageModal('indicateur', {{ ind.id }})" title="Editer">&#9998;</span>
                {% endif %}
            </label>
            {% if rc.value or rct.value %}
            <div class="val-box">
                {% if rc.value %}
                <div><span class="cc-tag cc-fonc">F</span> {{ rc.value }}{% if not rc.propre %} <span class="cc-origin">&larr; {{ rc.origine }}</span>{% endif %}</div>
                {% endif %}
                {% if rct.value %}
                <div><span class="cc-tag cc-tech">T</span> {{ rct.value }}{% if not rct.propre %} <span class="cc-origin">&larr; {{ rct.origine }}</span>{% endif %}</div>
                {% endif %}
            </div>
            {% else %}
            <div class="val-box" style="color:#555;font-style:italic">Non defini</div>
            {% endif %}
        </div>
        {% set rcf = ind.resolved.conformite_fonctionnel %}
        {% set rcft = ind.resolved.conformite_technique %}
        <div class="fiche-field">
            <label>Condition de conformite
                {% if session.get('user_role') != 'lecteur' %}
                <span class="fiche-edit-icon" onclick="openCiblageModal('indicateur', {{ ind.id }})" title="Editer">&#9998;</span>
                {% endif %}
            </label>
            {% if rcf.value or rcft.value %}
            <div class="val-box">
                {% if rcf.value %}
                <div><span class="cc-tag cc-fonc">F</span> {{ rcf.value }}{% if not rcf.propre %} <span class="cc-origin">&larr; {{ rcf.origine }}</span>{% endif %}</div>
                {% endif %}
                {% if rcft.value %}
                <div><span class="cc-tag cc-tech">T</span> {{ rcft.value }}{% if not rcft.propre %} <span class="cc-origin">&larr; {{ rcft.origine }}</span>{% endif %}</div>
                {% endif %}
            </div>
            {% else %}
            <div class="val-box" style="color:#555;font-style:italic">Non defini</div>
            {% endif %}
        </div>
        {% set rcc = ind.resolved.cc_commentaire %}
        {% set rcco = ind.resolved.cc_couleur %}
        {% if rcc.value or rcco.value %}
        <div class="fiche-field">
            <label>Commentaire general
                {% if session.get('user_role') != 'lecteur' %}
                <span class="fiche-edit-icon" onclick="openCiblageModal('indicateur', {{ ind.id }})" title="Editer">&#9998;</span>
                {% endif %}
            </label>
            <div class="val-box">
                {% if rcco.value %}<span class="status-dot c-{{ rcco.value }}" style="margin-right:6px"></span>{% endif %}{{ rcc.value or '' }}{% if rcc.value and not rcc.propre %} <span class="cc-origin">&larr; {{ rcc.origine }}</span>{% endif %}
            </div>
        </div>
        {% endif %}
        <a class="fiche-actions-link" href="{{ url_for('main.vue_kanban', id=ind.id) }}">
            Actions (Kanban) &rsaquo;
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="view-header">
    <div>
        <h2>{{ ind.code }}</h2>
        <div class="subtitle">{{ ind.description }}</div>
    </div>
</div>
<div class="wheel-area">
    <svg id="wh-ind" width="800" height="490" viewBox="0 0 800 490"></svg>
    <div class="right-panels">
        <div id="sp-ind"></div>
    </div>
</div>
{% endblock %}

{% if session.get('user_role') != 'lecteur' %}
<div class="kanban-modal-overlay" id="properties-modal-overlay" onclick="if(event.target===this)closePropertiesModal()">
    <div class="kanban-modal" style="max-width:440px">
        <h3>Proprietes de l'indicateur</h3>
        <div class="form-group">
            <label>Periodicite</label>
            <select class="form-input" id="prop-periodicite">
                <option value="Quotidien">Quotidien</option>
                <option value="Hebdomadaire">Hebdomadaire</option>
                <option value="Mensuel">Mensuel</option>
                <option value="Trimestriel">Trimestriel</option>
                <option value="Semestriel">Semestriel</option>
                <option value="Annuel">Annuel</option>
            </select>
        </div>
        <div class="form-group">
            <label>Valeur SLA (0 a 1)</label>
            <input type="number" class="form-input" id="prop-sla" step="0.01" min="0" max="1" placeholder="ex: 0.95">
        </div>
        <div class="form-group">
            <label>Formule KPI</label>
            <textarea class="form-input" id="prop-kpi" rows="2" placeholder="Formule de calcul..."></textarea>
        </div>
        <div class="form-group" style="display:flex;align-items:center;gap:8px">
            <input type="checkbox" id="prop-penalite" style="width:auto">
            <label for="prop-penalite" style="margin:0;cursor:pointer">Penalite applicable</label>
        </div>
        <div class="form-group">
            <label>Seuil (en secondes)</label>
            <input type="number" class="form-input" id="prop-seuil" min="0" placeholder="ex: 3600">
            <div style="font-size:11px;color:#666;margin-top:2px" id="prop-seuil-preview"></div>
        </div>
        <div class="form-actions">
            <button class="btn btn-secondary" onclick="closePropertiesModal()">Annuler</button>
            <button class="btn btn-primary" onclick="saveProperties()">Enregistrer</button>
        </div>
        <input type="hidden" id="prop-ind-id">
    </div>
</div>
{% endif %}

{% block scripts %}
<script>
function formatSeuil(s) {
    if (s === null || s === undefined || s === '') return '-';
    s = parseInt(s);
    if (isNaN(s) || s <= 0) return '-';
    var h = Math.floor(s / 3600);
    var m = Math.floor((s % 3600) / 60);
    var sec = s % 60;
    var parts = [];
    if (h > 0) parts.push(h + 'h');
    if (m > 0) parts.push(m + 'min');
    if (sec > 0 && h === 0) parts.push(sec + 's');
    return parts.join(' ') || '0s';
}

var _propIndId = null;

function openPropertiesModal(indId) {
    _propIndId = indId;
    document.getElementById('prop-ind-id').value = indId;
    fetch('/api/indicateur/' + indId + '/properties')
        .then(function(r) { return r.json(); })
        .then(function(d) {
            document.getElementById('prop-periodicite').value = d.periodicite || 'Mensuel';
            document.getElementById('prop-sla').value = d.sla_valeur !== null && d.sla_valeur !== undefined ? d.sla_valeur : '';
            document.getElementById('prop-kpi').value = d.kpi_formule || '';
            document.getElementById('prop-penalite').checked = !!d.penalite;
            document.getElementById('prop-seuil').value = d.seuil !== null && d.seuil !== undefined ? d.seuil : '';
            updateSeuilPreview();
            document.getElementById('properties-modal-overlay').classList.add('active');
        });
}

function closePropertiesModal() {
    document.getElementById('properties-modal-overlay').classList.remove('active');
}

function saveProperties() {
    var indId = document.getElementById('prop-ind-id').value;
    var slaVal = document.getElementById('prop-sla').value;
    var seuilVal = document.getElementById('prop-seuil').value;
    var body = {
        periodicite: document.getElementById('prop-periodicite').value,
        sla_valeur: slaVal !== '' ? parseFloat(slaVal) : null,
        kpi_formule: document.getElementById('prop-kpi').value || null,
        penalite: document.getElementById('prop-penalite').checked,
        seuil: seuilVal !== '' ? parseInt(seuilVal) : null
    };
    fetch('/api/indicateur/' + indId + '/properties', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(body)
    }).then(function(r) { return r.json(); })
      .then(function(d) {
          if (d.ok) location.reload();
      });
}

function updateSeuilPreview() {
    var v = document.getElementById('prop-seuil').value;
    document.getElementById('prop-seuil-preview').textContent = v ? formatSeuil(v) : '';
}

document.addEventListener('DOMContentLoaded', function() {
    var seuilInput = document.getElementById('prop-seuil');
    if (seuilInput) seuilInput.addEventListener('input', updateSeuilPreview);
    // Format seuil in fiche panel
    var ficheSeuilEl = document.getElementById('fiche-seuil-display');
    if (ficheSeuilEl) {
        var raw = ficheSeuilEl.textContent.replace('s', '');
        ficheSeuilEl.textContent = formatSeuil(raw);
    }
});

(function() {
    var stepData = {{ data.step_data|tojson }};
    var statusCounts = {{ data.status_counts|tojson }};
    var indicateurId = {{ data.indicateur.id }};
    var categorieId = {{ data.categorie.id }};

    drawIndicatorWheel('wh-ind', stepData, {
        centerCode: '{{ ind.code }}',
        centerDate: '{{ today }}',
        onClick: function(idx) {
            openModal(idx, 'indicateur', {
                stepData: stepData[idx],
                indicateur_id: indicateurId,
                categorie_id: categorieId,
                layerValues: stepData[idx]
            });
        }
    });

    buildStatusPanel('sp-ind', statusCounts);
})();
</script>
{% endblock %}
