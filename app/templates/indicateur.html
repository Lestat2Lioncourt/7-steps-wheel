{% extends "base.html" %}

{% block title %}Roue CSI - {{ data.indicateur.code }}{% endblock %}

{% block breadcrumb %}
<a href="{{ url_for('main.vue_globale') }}">Global</a>
<span class="sep"> &rsaquo; </span>
<a href="{{ url_for('main.vue_categorie', id=data.categorie.id) }}">{{ data.categorie.nom }}</a>
<span class="sep"> &rsaquo; </span>
<span class="current">{{ data.indicateur.code }}</span>
{% endblock %}

{% block sidebar %}
<div class="sidebar-section">
    <h4>Categories</h4>
    {% for cat in data.categories %}
    <a class="sidebar-item" href="{{ url_for('main.vue_categorie', id=cat.id) }}">
        <span class="sidebar-dot" style="background:{{ COL[cat.worst] }}"></span>
        <span>{{ cat.nom }}</span>
    </a>
    {% endfor %}
</div>
<div class="sidebar-divider"></div>
<div class="sidebar-section">
    <h4>Indicateurs</h4>
    {% for sib in data.siblings %}
    <a class="sidebar-item{% if sib.id == data.indicateur.id %} active{% endif %}"
       href="{{ url_for('main.vue_indicateur', id=sib.id) }}"
       title="{{ sib.code }} : {{ sib.description }}">
        <span class="sidebar-dot" style="background:{{ COL[sib.worst] }}"></span>
        <span style="font-size:10px">{{ sib.code }}</span>
    </a>
    {% endfor %}
</div>
{% endblock %}

{% set ind = data.indicateur %}
{% set type_class = 'fb-sla' if ind.type == 'SLA' else ('fb-kpi' if ind.type == 'KPI' else 'fb-xla') %}

{% block fiche_panel %}
<div class="fiche-panel">
    <div class="fiche-inner">
        <div class="fiche-title">{{ ind.code }}</div>
        <div class="fiche-desc">{{ ind.description }}</div>
        <div class="fiche-badges">
            <span class="fiche-badge {{ type_class }}">{{ ind.type }}</span>
            <span class="fiche-badge fb-etat">{{ ind.etat }}</span>
            <span class="fiche-badge" style="background:{{ COL[ind.worst] }}20;color:{{ COL[ind.worst] }};border:1px solid {{ COL[ind.worst] }}40">{{ COL_LABEL[ind.worst] }}</span>
        </div>
        <div class="fiche-field">
            <label>Chapitre</label>
            <div class="val">{{ ind.chapitre }}</div>
        </div>
        <div class="fiche-field">
            <label>Categorie</label>
            <div class="val">{{ data.categorie.nom }}</div>
        </div>
        {% set rc = ind.resolved.ciblage_fonctionnel %}
        {% set rct = ind.resolved.ciblage_technique %}
        <div class="fiche-field">
            <label>Condition de ciblage
                {% if session.get('user_role') != 'lecteur' %}
                <span class="fiche-edit-icon" onclick="openCiblageModal('indicateur', {{ ind.id }})" title="Editer">&#9998;</span>
                {% endif %}
            </label>
            {% if rc.value or rct.value %}
            <div class="val-box">
                {% if rc.value %}
                <div><span class="cc-tag cc-fonc">F</span> {{ rc.value }}{% if not rc.propre %} <span class="cc-origin">&larr; {{ rc.origine }}</span>{% endif %}</div>
                {% endif %}
                {% if rct.value %}
                <div><span class="cc-tag cc-tech">T</span> {{ rct.value }}{% if not rct.propre %} <span class="cc-origin">&larr; {{ rct.origine }}</span>{% endif %}</div>
                {% endif %}
            </div>
            {% else %}
            <div class="val-box" style="color:#555;font-style:italic">Non defini</div>
            {% endif %}
        </div>
        {% set rcf = ind.resolved.conformite_fonctionnel %}
        {% set rcft = ind.resolved.conformite_technique %}
        <div class="fiche-field">
            <label>Condition de conformite
                {% if session.get('user_role') != 'lecteur' %}
                <span class="fiche-edit-icon" onclick="openCiblageModal('indicateur', {{ ind.id }})" title="Editer">&#9998;</span>
                {% endif %}
            </label>
            {% if rcf.value or rcft.value %}
            <div class="val-box">
                {% if rcf.value %}
                <div><span class="cc-tag cc-fonc">F</span> {{ rcf.value }}{% if not rcf.propre %} <span class="cc-origin">&larr; {{ rcf.origine }}</span>{% endif %}</div>
                {% endif %}
                {% if rcft.value %}
                <div><span class="cc-tag cc-tech">T</span> {{ rcft.value }}{% if not rcft.propre %} <span class="cc-origin">&larr; {{ rcft.origine }}</span>{% endif %}</div>
                {% endif %}
            </div>
            {% else %}
            <div class="val-box" style="color:#555;font-style:italic">Non defini</div>
            {% endif %}
        </div>
        <a class="fiche-actions-link" href="{{ url_for('main.vue_kanban', id=ind.id) }}">
            Actions (Kanban) &rsaquo;
        </a>
    </div>
</div>
{% endblock %}

{% block content %}
<div class="view-header">
    <div>
        <h2>{{ ind.code }}</h2>
        <div class="subtitle">{{ ind.description }}</div>
    </div>
</div>
<div class="wheel-area">
    <svg id="wh-ind" width="800" height="490" viewBox="0 0 800 490"></svg>
    <div class="right-panels">
        <div id="sp-ind"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var stepData = {{ data.step_data|tojson }};
    var statusCounts = {{ data.status_counts|tojson }};
    var indicateurId = {{ data.indicateur.id }};
    var categorieId = {{ data.categorie.id }};

    drawIndicatorWheel('wh-ind', stepData, {
        centerCode: '{{ ind.code }}',
        centerDate: '{{ today }}',
        onClick: function(idx) {
            openModal(idx, 'indicateur', {
                stepData: stepData[idx],
                indicateur_id: indicateurId,
                categorie_id: categorieId,
                layerValues: stepData[idx]
            });
        }
    });

    buildStatusPanel('sp-ind', statusCounts);
})();
</script>
{% endblock %}
