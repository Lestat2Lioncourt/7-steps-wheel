{% extends "base.html" %}

{% block title %}Roue CSI - Vue Globale{% endblock %}

{% block breadcrumb %}
<span class="current">Vue Globale</span>
{% endblock %}

{% block sidebar %}
<div class="sidebar-section">
    <h4>Categories</h4>
    {% for cat in data.categories %}
    <a class="sidebar-item" href="{{ url_for('main.vue_categorie', id=cat.id) }}"
       title="{{ cat.nom }} - {{ cat.count }} indicateurs">
        <span class="sidebar-dot" style="background:{{ COL[cat.worst] }}"></span>
        <span>{{ cat.nom }}</span>
        <span class="sidebar-count">{{ cat.count }}</span>
    </a>
    {% endfor %}
</div>
{% endblock %}

{% block content %}
<div class="view-header">
    <div>
        <h2>Vue Globale</h2>
        <div class="subtitle">{{ data.total }} indicateurs</div>
    </div>
    {% if session.get('user_role') != 'lecteur' %}
    <button class="kanban-new-btn" style="background:#0f3460;margin-right:6px" onclick="openCiblageModal('projet')">Ciblage / Conformite</button>
    {% endif %}
    <a class="kanban-new-btn" href="{{ url_for('main.vue_kanban_global') }}" style="text-decoration:none">Actions (Kanban)</a>
</div>
<div class="wheel-area">
    <svg id="wh-global" width="800" height="490" viewBox="0 0 800 490"></svg>
    <div class="right-panels">
        <div id="sp-global"></div>
    </div>
</div>
<div class="hint">Cliquez sur une etape de la roue pour voir le detail</div>
<div class="drill-edit" id="drill-area"></div>
{% endblock %}

{% block scripts %}
<script>
(function() {
    var wheelColors = {{ data.wheel_colors|tojson }};
    var statusCounts = {{ data.status_counts|tojson }};
    var drillData = {{ drill_data|tojson }};
    var globalLayerValues = {{ global_layer_values|tojson }};

    // Reformater globalLayerValues en stepData pour drawIndicatorWheel
    var globalStepData = [];
    for (var i = 0; i < 7; i++) {
        var lv = globalLayerValues[i + 1] || {color: null, comment: ''};
        globalStepData.push({
            global: (lv.color || lv.comment) ? lv : null,
            categorie: null,
            indicateur: null
        });
    }

    drawIndicatorWheel('wh-global', globalStepData, {
        centerCode: 'VUE GLOBALE',
        centerDate: '{{ data.total }} indicateurs',
        wheelColors: wheelColors,
        onClick: function(idx) {
            showGlobalDrill(idx, drillData, globalLayerValues);
        },
        onCommentClick: function(idx) {
            var etape = idx + 1;
            openModal(idx, 'global', {
                layerValues: {global: globalLayerValues[etape] || {color: null, comment: ''}}
            });
        }
    });

    buildStatusPanel('sp-global', statusCounts);
})();
</script>
{% endblock %}
