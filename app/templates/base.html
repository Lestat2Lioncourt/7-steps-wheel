<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Roue CSI{% endblock %}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>

<!-- TOPBAR -->
<div class="topbar">
    <a href="{{ url_for('main.accueil') }}" style="text-decoration:none"><h1>Accueil</h1></a>
    <div class="main-tabs">
        <a class="main-tab{% if active_tab == 'roue' %} active{% endif %}" href="{{ url_for('main.vue_globale') }}">{{ project_name }}</a>
        <a class="main-tab{% if active_tab == 'referentiel' %} active{% endif %}" href="{{ url_for('main.vue_referentiel') }}">Referentiel</a>
        {% if session.get('user_role') in ('admin', 'membre', 'lecteur') or session.get('user_real_role') == 'admin' %}
        <a class="main-tab{% if active_tab == 'membres' %} active{% endif %}" href="{{ url_for('main.vue_membres') }}">Membres</a>
        {% endif %}
    </div>
    <div class="topbar-right">
        <div class="inline-counters" id="counters"></div>
        <div class="breadcrumb">
            {% block breadcrumb %}
            <span class="current">Vue Globale</span>
            {% endblock %}
        </div>
        {% if session.get('user_real_role') == 'admin' or (session.get('user_role') == 'admin' and not session.get('user_real_role')) %}
        <button class="switch-role-btn" onclick="switchRole()" id="switch-role-btn">
            {% if session.get('user_role') == 'admin' %}Mode membre{% else %}Mode admin{% endif %}
        </button>
        {% endif %}
        <span class="user-badge" title="{{ session.get('user_email', '') }}">
            <span class="user-avatar">{{ session.get('user_trigramme', '') or session.get('user_nom', '?')[:1] }}</span>
            <span>{{ session.get('user_nom', '') }}</span>
        </span>
    </div>
</div>

<!-- MAIN LAYOUT -->
<div class="main-layout">
    <!-- SIDEBAR -->
    <div class="sidebar">
        {% block sidebar %}{% endblock %}
    </div>

    <!-- FICHE PANEL (indicateur only) -->
    {% block fiche_panel %}{% endblock %}

    <!-- CONTENT -->
    <div class="content">
        {% block content %}{% endblock %}
    </div>
</div>

<!-- MODAL OVERLAY -->
<div class="modal-overlay" id="modal-overlay" onclick="if(event.target===this)closeModal()">
    <div class="modal">
        <h3 id="modal-title">Etape</h3>
        <div class="modal-note" id="modal-note"></div>
        <div class="color-picker" id="modal-colors">
            <div>
                <div class="color-btn" style="background:#6b7280" data-color="grey" onclick="selColor(this)"></div>
                <span class="color-btn-label">Aucun</span>
            </div>
            <div>
                <div class="color-btn" style="background:#22c55e" data-color="green" onclick="selColor(this)"></div>
                <span class="color-btn-label">Valid√©</span>
            </div>
            <div>
                <div class="color-btn" style="background:#eab308" data-color="yellow" onclick="selColor(this)"></div>
                <span class="color-btn-label">En cours</span>
            </div>
            <div>
                <div class="color-btn" style="background:#f97316" data-color="orange" onclick="selColor(this)"></div>
                <span class="color-btn-label">Warning</span>
            </div>
            <div>
                <div class="color-btn" style="background:#dc2626" data-color="red" onclick="selColor(this)"></div>
                <span class="color-btn-label">Blocage</span>
            </div>
        </div>
        <div class="modal-tabs" id="modal-tabs"></div>
        <textarea class="modal-comment" id="modal-comment" placeholder="Commentaire..."></textarea>
        <div class="modal-actions">
            {% if session.get('user_role') != 'lecteur' %}
            <button class="btn-clear" id="modal-clear" onclick="clearLayer()">Vider cette couche</button>
            <a class="btn-action-link" id="modal-action-link" style="display:none" onclick="goToKanbanNew()">+ Action</a>
            <span style="flex:1"></span>
            <button class="btn btn-secondary" onclick="closeModal()">Annuler</button>
            <button class="btn btn-primary" onclick="saveModal()">Enregistrer</button>
            {% else %}
            <span style="flex:1"></span>
            <button class="btn btn-secondary" onclick="closeModal()">Fermer</button>
            {% endif %}
        </div>
    </div>
</div>

<!-- CIBLAGE/CONFORMITE MODAL -->
<div class="modal-overlay" id="ciblage-modal-overlay" onclick="if(event.target===this)closeCiblageModal()">
    <div class="modal" style="width:560px">
        <h3 id="ciblage-modal-title">Ciblage / Conformite</h3>
        <div class="modal-note" id="ciblage-modal-note">Les valeurs definies ici sont heritees par les niveaux inferieurs (sauf s'ils definissent les leurs).</div>
        <div class="cc-form-section">
            <div class="cc-form-section-title">Ciblage</div>
            <div class="cc-form-row">
                <div class="cc-form-field">
                    <label><span class="cc-tag cc-fonc">F</span> Fonctionnel</label>
                    <textarea id="cc-ciblage-fonc" class="modal-comment" placeholder="Condition de ciblage fonctionnelle..."></textarea>
                </div>
                <div class="cc-form-field">
                    <label><span class="cc-tag cc-tech">T</span> Technique</label>
                    <textarea id="cc-ciblage-tech" class="modal-comment" placeholder="Condition de ciblage technique..."></textarea>
                </div>
            </div>
        </div>
        <div class="cc-form-section">
            <div class="cc-form-section-title">Conformite</div>
            <div class="cc-form-row">
                <div class="cc-form-field">
                    <label><span class="cc-tag cc-fonc">F</span> Fonctionnel</label>
                    <textarea id="cc-conformite-fonc" class="modal-comment" placeholder="Condition de conformite fonctionnelle..."></textarea>
                </div>
                <div class="cc-form-field">
                    <label><span class="cc-tag cc-tech">T</span> Technique</label>
                    <textarea id="cc-conformite-tech" class="modal-comment" placeholder="Condition de conformite technique..."></textarea>
                </div>
            </div>
        </div>
        <div class="modal-actions">
            {% if session.get('user_role') != 'lecteur' %}
            <button class="btn-clear" onclick="clearCiblage()">Vider ce niveau</button>
            <span style="flex:1"></span>
            <button class="btn btn-secondary" onclick="closeCiblageModal()">Annuler</button>
            <button class="btn btn-primary" onclick="saveCiblage()">Enregistrer</button>
            {% else %}
            <span style="flex:1"></span>
            <button class="btn btn-secondary" onclick="closeCiblageModal()">Fermer</button>
            {% endif %}
        </div>
    </div>
</div>

<script>
    window._userRole = '{{ session.get("user_role", "") }}';
    window._userRealRole = '{{ session.get("user_real_role", "") }}';
    function switchRole() {
        fetch('/api/switch-role', { method: 'POST', headers: { 'Content-Type': 'application/json' } })
        .then(function(r) { return r.json(); })
        .then(function(data) {
            if (data.ok) { location.reload(); }
            else { alert(data.error || 'Erreur'); }
        });
    }
</script>
<script src="{{ url_for('static', filename='js/wheel.js') }}"></script>
<script>
    // Compteurs topbar
    buildInlineCounters('counters', {{ global_counts|tojson }});
</script>
{% block scripts %}{% endblock %}
</body>
</html>
