{% extends "base.html" %}

{% block title %}Roue CSI - Referentiel{% endblock %}

{% block breadcrumb %}
<span class="current">Referentiel</span>
{% endblock %}

{% block sidebar %}
<div class="sidebar-section">
    <h4>Filtres rapides</h4>
    <div class="sidebar-item active" onclick="qfCat(this, 'all')">
        <span style="color:#888">Tous</span>
        <span class="sidebar-count">{{ data.total }}</span>
    </div>
    {% for cat in data.categories %}
    <div class="sidebar-item" onclick="qfCat(this, '{{ cat.nom }}')">
        <span class="sidebar-dot" style="background:{{ COL[cat.worst] }}"></span>
        <span style="flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">{{ cat.nom }}</span>
        <span class="sidebar-count">{{ cat.count }}</span>
        {% if session.get('user_role') == 'admin' %}
        <span class="sidebar-actions" onclick="event.stopPropagation()">
            <button class="sidebar-action-btn" onclick="reorderCategory({{ cat.id }}, 'up')" title="Monter">&#9650;</button>
            <button class="sidebar-action-btn" onclick="reorderCategory({{ cat.id }}, 'down')" title="Descendre">&#9660;</button>
            <button class="sidebar-action-btn" onclick="openCategoryModal({{ cat.id }}, '{{ cat.nom|e }}')" title="Renommer">&#9998;</button>
            <button class="sidebar-action-btn sidebar-action-delete" onclick="deleteCategory({{ cat.id }}, '{{ cat.nom|e }}')" title="Supprimer">&#10005;</button>
        </span>
        {% endif %}
    </div>
    {% endfor %}
</div>
{% endblock %}

{% block content %}
<div class="ref-header">
    <div style="display:flex;align-items:center;gap:12px">
        <h2>Referentiel des indicateurs</h2>
        {% if session.get('user_role') == 'admin' %}
        <button class="ref-add-btn" onclick="openCategoryModal(null, '')">+ Categorie</button>
        {% endif %}
    </div>
    <div class="subtitle">Design et parametrage des indicateurs</div>
</div>

<div class="ref-toolbar">
    <input type="text" class="search-input" placeholder="Rechercher par code, description..." id="ref-search">
    <select class="filter-select" id="ref-cat-filter">
        <option value="all">Toutes categories</option>
        {% for cat in data.categories %}
        <option value="{{ cat.nom }}">{{ cat.nom }}</option>
        {% endfor %}
    </select>
    <select class="filter-select" id="ref-type-filter">
        <option value="all">Tous types</option>
        {% for t in data.types %}
        <option value="{{ t.intitule }}">{{ t.intitule }}</option>
        {% endfor %}
    </select>
    <select class="filter-select" id="ref-etat-filter">
        <option value="all">Tous etats</option>
        {% for e in data.etats %}
        <option value="{{ e.intitule }}">{{ e.intitule }}</option>
        {% endfor %}
    </select>
</div>

<div class="ref-stats" id="ref-stats"></div>

<div class="table-area">
    <table class="ref-table">
        <thead>
            <tr>
                <th>CSI</th>
                <th>Chap.</th>
                <th>Code</th>
                <th>Description</th>
                <th>Categorie</th>
                <th>Type</th>
                <th>Etat</th>
                <th>Period.</th>
                <th>SLA</th>
                <th>KPI</th>
                <th>Pen.</th>
                <th>Seuil</th>
                <th>Ciblage</th>
                <th>Conformite</th>
                <th></th>
            </tr>
        </thead>
        <tbody id="ref-body">
            {% for ind in data.indicateurs %}
            <tr class="ref-row"
                data-code="{{ ind.code }}"
                data-desc="{{ ind.description }}"
                data-cat="{{ ind.categorie_nom }}"
                data-type="{{ ind.type }}"
                data-etat="{{ ind.etat }}"
                data-worst="{{ ind.worst }}"
                onclick="location.href='{{ url_for('main.vue_indicateur', id=ind.id) }}'">
                <td><span class="status-dot c-{{ ind.worst }}"></span></td>
                <td style="color:#888;font-size:11px">{{ ind.chapitre }}</td>
                <td style="font-weight:600;white-space:nowrap">{{ ind.code }}</td>
                <td>{{ ind.description }}</td>
                <td style="color:#777;font-size:11px">{{ ind.categorie_nom }}</td>
                <td><span class="type-badge {{ ind.type_class }}">{{ ind.type }}</span></td>
                <td><span class="etat-badge {{ ind.etat_class }}">{{ ind.etat }}</span></td>
                <td style="font-size:11px;color:#999">{{ ind.periodicite or '' }}</td>
                <td style="font-size:11px;color:#999">{% if ind.sla_valeur is not none %}{{ (ind.sla_valeur * 100)|round(1)|int }}%{% endif %}</td>
                <td style="font-size:11px;color:#999;max-width:100px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" title="{{ ind.kpi_formule or '' }}">{{ ind.kpi_formule or '' }}</td>
                <td style="font-size:11px;color:#999">{% if ind.penalite %}Oui{% elif ind.penalite is not none %}Non{% endif %}</td>
                <td style="font-size:11px;color:#999">{% if ind.seuil is not none %}<span class="ref-seuil" data-seuil="{{ ind.seuil }}">{{ ind.seuil }}s</span>{% endif %}</td>
                {% set rcib = ind.resolved.ciblage_fonctionnel %}
                {% set rcibt = ind.resolved.ciblage_technique %}
                <td style="font-size:11px;color:#999;max-width:160px" title="{% if rcib.value %}[F] {{ rcib.value }}{% endif %}{% if rcibt.value %}&#10;[T] {{ rcibt.value }}{% endif %}">{% if rcib.value %}{{ rcib.value[:23] ~ '...' if rcib.value|length > 25 else rcib.value }}{% endif %}{% if rcibt.value %} <span class="cc-tag-mini cc-tech">T</span>{% endif %}</td>
                {% set rconf = ind.resolved.conformite_fonctionnel %}
                {% set rconft = ind.resolved.conformite_technique %}
                <td style="font-size:11px;color:#999;max-width:160px" title="{% if rconf.value %}[F] {{ rconf.value }}{% endif %}{% if rconft.value %}&#10;[T] {{ rconft.value }}{% endif %}">{% if rconf.value %}{{ rconf.value[:23] ~ '...' if rconf.value|length > 25 else rconf.value }}{% endif %}{% if rconft.value %} <span class="cc-tag-mini cc-tech">T</span>{% endif %}</td>
                <td><a class="roue-link" href="{{ url_for('main.vue_indicateur', id=ind.id) }}" onclick="event.stopPropagation()">Roue</a></td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

{% if session.get('user_role') == 'admin' %}
<div class="kanban-modal-overlay" id="category-modal-overlay" onclick="if(event.target===this)closeCategoryModal()">
    <div class="kanban-modal">
        <h3 id="category-modal-title">Ajouter une categorie</h3>
        <div class="form-group">
            <label>Nom</label>
            <input type="text" class="form-input" id="category-modal-nom" placeholder="Nom de la categorie">
        </div>
        <div class="form-actions">
            <button class="btn btn-secondary" onclick="closeCategoryModal()">Annuler</button>
            <button class="btn btn-primary" onclick="submitCategory()">Enregistrer</button>
        </div>
        <input type="hidden" id="category-modal-id">
    </div>
</div>
{% endif %}
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/referentiel.js') }}"></script>
<script>initReferentiel();</script>
{% endblock %}
