<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roue CSI - Prototype 3 (Fiche fixe + Referentiel)</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Segoe UI',Tahoma,sans-serif; background:#1a1a2e; color:#e0e0e0; height:100vh; display:flex; flex-direction:column; overflow:hidden; }

        /* ---- TOPBAR ---- */
        .topbar { background:#16213e; padding:0 24px; display:flex; align-items:stretch; border-bottom:2px solid #0f3460; flex-shrink:0; }
        .topbar h1 { font-size:18px; color:#e94560; display:flex; align-items:center; margin-right:24px; }
        .main-tabs { display:flex; }
        .main-tab { padding:13px 20px; cursor:pointer; font-size:13px; font-weight:600; color:#555; border-bottom:3px solid transparent; transition:all 0.2s; display:flex; align-items:center; gap:7px; }
        .main-tab:hover { color:#aaa; }
        .main-tab.active { color:#fff; border-bottom-color:#e94560; }
        .topbar-right { margin-left:auto; display:flex; align-items:center; gap:12px; }
        .breadcrumb { display:flex; gap:6px; align-items:center; font-size:13px; }
        .breadcrumb a { color:#a0c4ff; text-decoration:none; cursor:pointer; }
        .breadcrumb a:hover { text-decoration:underline; }
        .breadcrumb .sep { color:#555; }
        .breadcrumb .current { color:#fff; font-weight:600; }

        /* Inline counters */
        .inline-counters { display:flex; gap:6px; align-items:center; }
        .ic { display:inline-flex; align-items:center; gap:3px; font-size:11px; font-weight:700; padding:2px 8px; border-radius:10px; background:rgba(255,255,255,0.05); }
        .ic .ic-dot { width:7px; height:7px; border-radius:50%; }

        /* ---- MAIN LAYOUT ---- */
        .main-layout { display:flex; flex:1; overflow:hidden; }

        /* ---- SIDEBAR ---- */
        .sidebar { width:220px; min-width:220px; background:#16213e; border-right:1px solid #0f3460; overflow-y:auto; flex-shrink:0; }
        .sidebar-section { padding:12px; }
        .sidebar-section h4 { font-size:10px; text-transform:uppercase; letter-spacing:1px; color:#555; margin-bottom:6px; }
        .sidebar-item { display:flex; align-items:center; gap:7px; padding:5px 9px; border-radius:5px; cursor:pointer; font-size:11px; transition:background 0.15s; margin-bottom:1px; }
        .sidebar-item:hover { background:#1a2744; }
        .sidebar-item.active { background:#0f3460; color:#fff; }
        .sidebar-dot { width:8px; height:8px; border-radius:50%; flex-shrink:0; }
        .sidebar-count { margin-left:auto; font-size:10px; color:#444; }
        .sidebar-divider { height:1px; background:#0f3460; margin:4px 12px; }

        /* ---- FICHE PANEL (fixed vertical, indicator level only) ---- */
        .fiche-panel {
            width:0; min-width:0; overflow:hidden; background:#16213e;
            border-right:1px solid #0f3460; transition:all 0.3s ease; flex-shrink:0;
        }
        .fiche-panel.visible { width:235px; min-width:235px; overflow-y:auto; }
        .fiche-inner { width:235px; padding:16px; }
        .fiche-title { font-size:14px; font-weight:700; color:#fff; margin-bottom:2px; word-break:break-word; }
        .fiche-desc { font-size:11px; color:#999; margin-bottom:12px; line-height:1.4; }
        .fiche-badges { display:flex; gap:6px; margin-bottom:14px; flex-wrap:wrap; }
        .fiche-badge { padding:2px 10px; border-radius:8px; font-size:10px; font-weight:600; }
        .fb-sla { background:#0f3460; color:#a0c4ff; }
        .fb-kpi { background:#1a3020; color:#66bb6a; }
        .fb-xla { background:#302010; color:#ffb74d; }
        .fb-etat { background:#302a10; color:#eab308; }
        .fiche-field { margin-bottom:12px; }
        .fiche-field label { font-size:9px; text-transform:uppercase; letter-spacing:1px; color:#555; display:block; margin-bottom:3px; }
        .fiche-field .val { font-size:12px; color:#ccc; line-height:1.4; }
        .fiche-field .val-box { font-size:11px; color:#ccc; line-height:1.5; background:#0f1a30; padding:8px 10px; border-radius:5px; border-left:3px solid #3a7bd5; }
        .fiche-edit { font-size:10px; color:#a0c4ff; cursor:pointer; margin-top:3px; display:inline-block; }
        .fiche-edit:hover { text-decoration:underline; }
        .fiche-actions-link { display:flex; align-items:center; gap:6px; padding:8px 12px; margin-top:10px; background:#0f1a30; border-radius:6px; cursor:pointer; font-size:12px; color:#a0c4ff; font-weight:600; transition:background 0.15s; }
        .fiche-actions-link:hover { background:#1a2744; }

        /* ---- CONTENT ---- */
        .content { flex:1; overflow-y:auto; display:flex; flex-direction:column; }
        .section { display:none; flex:1; flex-direction:column; }
        .section.active { display:flex; }

        /* ---- VIEW HEADER ---- */
        .view-header { display:flex; align-items:center; gap:16px; padding:12px 20px 8px; flex-shrink:0; flex-wrap:wrap; }
        .view-header h2 { font-size:17px; color:#fff; }
        .view-header .subtitle { font-size:11px; color:#666; }

        /* ---- WHEEL ---- */
        .wheel-area { display:flex; align-items:flex-start; justify-content:center; padding:10px 16px; gap:14px; flex-shrink:0; flex-wrap:nowrap; }
        .step-ellipse { cursor:pointer; transition:filter 0.2s; }
        .step-ellipse:hover { filter:brightness(1.2) drop-shadow(0 0 8px rgba(255,255,255,0.3)); }
        .step-label { pointer-events:none; font-weight:600; font-size:12px; fill:#fff; text-anchor:middle; dominant-baseline:central; }
        .arrow-path { fill:none; stroke:#3a7bd5; stroke-width:2.5; }
        .center-title { font-size:11px; fill:#777; text-anchor:middle; }
        .center-date { font-size:16px; fill:#fff; text-anchor:middle; font-weight:700; }
        .comment-line { stroke:#444; stroke-width:1; stroke-dasharray:4,3; }
        .comment-box-bg { fill:#16213e; stroke:#2a2a4a; stroke-width:1; }
        .comment-text { fill:#bbb; font-size:10px; }
        .comment-step-label { fill:#a0c4ff; font-size:10px; font-weight:600; }
        .comment-badge-text { fill:#fff; font-size:8px; font-weight:700; text-anchor:middle; dominant-baseline:central; }

        /* Status panel & history */
        .right-panels { display:flex; flex-direction:column; gap:10px; flex-shrink:0; }
        .status-panel { min-width:170px; }
        .status-filter-item { display:flex; align-items:center; gap:6px; padding:5px 10px; border-radius:5px; cursor:pointer; font-size:11px; margin-bottom:1px; }
        .status-filter-item:hover { background:#1a2744; }
        .sf-dot { width:9px; height:9px; border-radius:50%; flex-shrink:0; }
        .sf-label { flex:1; }
        .sf-count { font-size:10px; color:#666; }
        .history-panel h4 { font-size:10px; color:#555; margin-bottom:6px; text-transform:uppercase; letter-spacing:1px; }
        .history-date { padding:4px 8px; font-size:11px; cursor:pointer; border-radius:4px; margin-bottom:1px; }
        .history-date:hover { background:#1a2744; }
        .history-date.active { background:#0f3460; color:#fff; }

        .hint { text-align:center; color:#444; font-size:11px; padding:6px; flex-shrink:0; }

        /* ---- DRILL TABLE ---- */
        .drill-area { padding:0 20px 16px; overflow-y:auto; }
        .drill-table { width:100%; max-width:800px; margin:0 auto; border-collapse:collapse; }
        .drill-table th { background:#0f3460; padding:7px 12px; text-align:left; font-size:11px; color:#a0c4ff; }
        .drill-table td { padding:6px 12px; border-bottom:1px solid #1a1a2e; font-size:12px; cursor:pointer; }
        .drill-table tr:hover td { background:#1a2744; }
        .status-dot { display:inline-block; width:10px; height:10px; border-radius:50%; margin-right:5px; vertical-align:middle; }

        /* ---- REFERENTIEL ---- */
        .ref-header { padding:18px 24px 10px; flex-shrink:0; }
        .ref-header h2 { font-size:19px; color:#fff; margin-bottom:3px; }
        .ref-header .subtitle { font-size:12px; color:#666; }
        .ref-toolbar { display:flex; gap:10px; align-items:center; padding:0 24px 12px; flex-wrap:wrap; flex-shrink:0; }
        .search-input { background:#0f1a30; border:1px solid #333; border-radius:6px; padding:7px 12px; color:#e0e0e0; font-size:12px; width:260px; }
        .search-input::placeholder { color:#555; }
        .filter-select { background:#0f1a30; border:1px solid #333; border-radius:6px; padding:6px 10px; color:#e0e0e0; font-size:11px; }
        .ref-stats { display:flex; gap:10px; padding:0 24px 10px; flex-shrink:0; font-size:11px; color:#888; }
        .ref-stat { display:flex; align-items:center; gap:4px; }
        .ref-stat .n { font-weight:700; color:#ccc; }
        .table-area { padding:0 24px 20px; overflow-y:auto; flex:1; }
        .ref-table { width:100%; border-collapse:collapse; font-size:12px; }
        .ref-table th { background:#0f3460; padding:8px 10px; text-align:left; color:#a0c4ff; font-size:10px; text-transform:uppercase; letter-spacing:0.5px; position:sticky; top:0; z-index:2; white-space:nowrap; }
        .ref-table td { padding:7px 10px; border-bottom:1px solid #1a1a2e; }
        .ref-table tr { cursor:pointer; transition:background 0.15s; }
        .ref-table tr:hover td { background:#1a2744; }
        .type-badge { display:inline-block; padding:1px 7px; border-radius:8px; font-size:10px; font-weight:600; }
        .type-sla{background:#0f3460;color:#a0c4ff} .type-kpi{background:#1a3020;color:#66bb6a} .type-xla{background:#302010;color:#ffb74d}
        .etat-badge { display:inline-block; padding:1px 7px; border-radius:8px; font-size:10px; }
        .etat-realise{background:#1a3020;color:#66bb6a} .etat-encours{background:#302a10;color:#eab308} .etat-acadrer{background:#201520;color:#ce93d8}
        .roue-link { color:#a0c4ff; font-size:11px; cursor:pointer; white-space:nowrap; }
        .roue-link:hover { text-decoration:underline; }

        /* COLORS */
        .c-grey{background:#6b7280} .c-green{background:#22c55e} .c-yellow{background:#eab308} .c-orange{background:#f97316} .c-red{background:#dc2626}
    </style>
</head>
<body>

<div class="topbar">
    <h1>ROUE CSI</h1>
    <div class="main-tabs">
        <div class="main-tab active" onclick="switchSection('roue')" id="tab-roue">Roue CSI</div>
        <div class="main-tab" onclick="switchSection('referentiel')" id="tab-referentiel">Referentiel</div>
    </div>
    <div class="topbar-right">
        <div class="inline-counters" id="inline-counters"></div>
        <div class="breadcrumb" id="breadcrumb"><span class="current">Vue Globale</span></div>
    </div>
</div>

<div class="main-layout">
    <div class="sidebar" id="sidebar"></div>
    <div class="fiche-panel" id="fiche-panel"><div class="fiche-inner" id="fiche-inner"></div></div>
    <div class="content">

        <!-- ======= SECTION ROUE ======= -->
        <div class="section active" id="section-roue">

            <!-- VUE GLOBALE -->
            <div id="view-global">
                <div class="view-header"><div><h2>Vue Globale</h2><div class="subtitle">49 indicateurs</div></div></div>
                <div class="wheel-area">
                    <svg id="wheel-global" width="440" height="440" viewBox="0 0 440 440"></svg>
                    <div class="right-panels"><div class="status-panel" id="sp-global"></div></div>
                </div>
                <div class="hint">Cliquez sur une etape pour voir la repartition | Cliquez un indicateur a gauche pour voir sa fiche et sa roue</div>
                <div class="drill-area" id="global-drill" style="display:none">
                    <h3 style="text-align:center;margin-bottom:10px;color:#a0c4ff;font-size:13px" id="global-drill-title"></h3>
                    <table class="drill-table"><thead><tr><th>Categorie</th><th>Statut</th><th>Indicateurs</th></tr></thead><tbody id="global-drill-body"></tbody></table>
                </div>
            </div>

            <!-- VUE CATEGORIE -->
            <div id="view-category" style="display:none">
                <div class="view-header"><div><h2 id="cat-title">Process Incident</h2><div class="subtitle">10 indicateurs</div></div></div>
                <div class="wheel-area">
                    <svg id="wheel-category" width="440" height="440" viewBox="0 0 440 440"></svg>
                    <div class="right-panels"><div class="status-panel" id="sp-category"></div></div>
                </div>
                <div class="hint">Cliquez un indicateur a gauche pour voir sa fiche et sa roue</div>
                <div class="drill-area" id="cat-drill" style="display:none">
                    <h3 style="text-align:center;margin-bottom:10px;color:#a0c4ff;font-size:13px" id="cat-drill-title"></h3>
                    <table class="drill-table"><thead><tr><th>Indicateur</th><th>Description</th><th>Statut</th></tr></thead><tbody id="cat-drill-body"></tbody></table>
                </div>
            </div>

            <!-- VUE INDICATEUR -->
            <div id="view-indicator" style="display:none">
                <div class="view-header"><div><h2 id="ind-title">ITR_QUAL_REF_TECH</h2><div class="subtitle" id="ind-subtitle">Qualite de la gestion des referentiels techniques</div></div></div>
                <div class="wheel-area">
                    <svg id="wheel-indicator" width="800" height="490" viewBox="0 0 800 490"></svg>
                    <div class="right-panels">
                        <div class="status-panel" id="sp-indicator"></div>
                        <div class="history-panel">
                            <h4>Historique</h4>
                            <div class="history-date active">16/02/2026</div>
                            <div class="history-date">15/01/2026</div>
                            <div class="history-date">12/12/2025</div>
                            <div class="history-date">20/11/2025</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ======= SECTION REFERENTIEL ======= -->
        <div class="section" id="section-referentiel">
            <div class="ref-header"><h2>Referentiel des indicateurs</h2><div class="subtitle">Design et parametrage des indicateurs</div></div>
            <div class="ref-toolbar">
                <input type="text" class="search-input" placeholder="Rechercher par code, description..." oninput="filterRef()" id="ref-search">
                <select class="filter-select" onchange="filterRef()" id="ref-cat-filter"><option value="all">Toutes categories</option></select>
                <select class="filter-select" onchange="filterRef()" id="ref-type-filter"><option value="all">Tous types</option><option>SLA</option><option>KPI</option><option>XLA</option></select>
                <select class="filter-select" onchange="filterRef()" id="ref-etat-filter"><option value="all">Tous etats</option><option>Realise</option><option>En cours</option><option>A cadrer</option></select>
            </div>
            <div class="ref-stats" id="ref-stats"></div>
            <div class="table-area">
                <table class="ref-table"><thead><tr><th>CSI</th><th>Chap.</th><th>Code</th><th>Description</th><th>Categorie</th><th>Type</th><th>Etat</th><th>Ciblage</th><th>Conformite</th><th></th></tr></thead><tbody id="ref-body"></tbody></table>
            </div>
        </div>

    </div>
</div>

<script>
// ===================== DATA =====================
const COL={grey:'#6b7280',green:'#22c55e',yellow:'#eab308',orange:'#f97316',red:'#dc2626'};
const COL_L={grey:'Non eval.',green:'Valide',yellow:'En cours',orange:'Warning',red:'Blocage'};
const STEPS=[
    {label:"Ce qu'on\nVEUT",short:"Ce qu'on VEUT",tip:"Definir l'objectif de mesure"},
    {label:"Ce qu'on\nPEUT",short:"Ce qu'on PEUT",tip:"Identifier ce qui est techniquement mesurable"},
    {label:"COLLECTE",short:"COLLECTE",tip:"Collecter les donnees brutes"},
    {label:"DATA\nPREP",short:"DATA PREP",tip:"Preparer et transformer les donnees"},
    {label:"DATA\nQUALITY",short:"DATA QUALITY",tip:"Verifier qualite et fiabilite"},
    {label:"DATA VIZ\n& USAGE",short:"DATA VIZ & USAGE",tip:"Visualiser et exploiter les resultats"},
    {label:"BILAN",short:"BILAN",tip:"Bilan et axes d'amelioration"}
];
const LAYERS={global:{b:'G',c:'#e94560'},categorie:{b:'C',c:'#3a7bd5'},indicateur:{b:'I',c:'#8b5cf6'}};

const CATEGORIES=[
    {name:'SLA Transverse',count:12,worst:'orange'},{name:'Service Desk',count:8,worst:'orange'},
    {name:'Process Incident',count:10,worst:'red'},{name:'Process Demande',count:7,worst:'yellow'},
    {name:'Gestion des stocks',count:3,worst:'green'},{name:'Marche de location',count:2,worst:'grey'},
    {name:'Pilotage',count:7,worst:'yellow'}
];

const INDICATORS=[
    {code:'IQ_INC_1',chap:'4.2.1',desc:"Resolution incident 'Bloque'",cat:'Process Incident',type:'SLA',etat:'Realise',ciblage:'Tous les incidents de priorite Bloquant',conformite:'Delai de resolution <= 4h ouvrees',worst:'green'},
    {code:'IQ_INC_1A',chap:'4.2.1.1',desc:"Resolution 'Bloque' (4h)",cat:'Process Incident',type:'SLA',etat:'Realise',ciblage:'Incidents P1 hors maintenance programmee',conformite:'95% resolus en moins de 4h',worst:'green'},
    {code:'IQ_INC_2',chap:'4.2.2',desc:"Resolution incident 'Gene'",cat:'Process Incident',type:'SLA',etat:'Realise',ciblage:'Tous les incidents de priorite Gene',conformite:'Delai de resolution <= 12h ouvrees',worst:'green'},
    {code:'IQ_INC_NON_RES',chap:'4.2.5',desc:'Non-resolution des tickets',cat:'Process Incident',type:'KPI',etat:'En cours',ciblage:'Tickets ouverts depuis plus de 30 jours',conformite:'Taux de non-resolution < 5%',worst:'red'},
    {code:'IQ_INC_ESCAL',chap:'4.2.6',desc:"Delais et qualite de l'escalade",cat:'Process Incident',type:'SLA',etat:'En cours',ciblage:'Escalades techniques et hierarchiques',conformite:'100% des escalades notifiees sous 1h',worst:'orange'},
    {code:'IQ_INC_PROP',chap:'4.2.7',desc:'Propositions amelioration',cat:'Process Incident',type:'KPI',etat:'A cadrer',ciblage:'Propositions emises par les equipes',conformite:'Au moins 2 propositions par trimestre',worst:'grey'},
    {code:'ITR_QUAL_REF_TECH',chap:'4.1.3',desc:'Qualite gestion referentiels techniques',cat:'SLA Transverse',type:'SLA',etat:'En cours',ciblage:'Liste des donnees des referentiels techniques',conformite:"Nombre d'erreurs <= 5",worst:'orange'},
    {code:'ITR_REP_PROJET_TSD',chap:'4.1.4',desc:'Reporting projet et TSD',cat:'SLA Transverse',type:'SLA',etat:'A cadrer',ciblage:'Rapports mensuels de pilotage',conformite:'Livraison avant le 5 du mois',worst:'yellow'},
    {code:'ISD_APPEL_DECROCHE',chap:'4.3.1',desc:'Taux appels decroches',cat:'Service Desk',type:'SLA',etat:'Realise',ciblage:'Appels entrants sur la plage horaire',conformite:'Taux decroche >= 95%',worst:'orange'},
    {code:'IQ_REQ_TRAITEMENT',chap:'4.4.1',desc:'Delai traitement des demandes',cat:'Process Demande',type:'SLA',etat:'En cours',ciblage:'Demandes standard catalogue',conformite:'80% traitees en 5 jours',worst:'yellow'},
    {code:'IQ_PARC_STOCK',chap:'4.5.1',desc:'Gestion du stock',cat:'Gestion des stocks',type:'KPI',etat:'Realise',ciblage:'Materiel en stock actif',conformite:'Ecart inventaire < 2%',worst:'green'},
    {code:'IQ_LOC_RESTIT',chap:'4.6.1',desc:'Restitution materiel location',cat:'Marche de location',type:'KPI',etat:'A cadrer',ciblage:'Materiel en fin de contrat de location',conformite:'100% restitue sous 30 jours',worst:'grey'},
    {code:'IP_TENUE_COMITE',chap:'4.7.1',desc:'Tenue des comites de pilotage',cat:'Pilotage',type:'KPI',etat:'En cours',ciblage:'Comites mensuels et trimestriels',conformite:'100% des comites tenus',worst:'yellow'},
    {code:'IP_ENVIRON_TRAVAIL',chap:'4.7.2',desc:'Environnement de travail',cat:'Pilotage',type:'XLA',etat:'En cours',ciblage:"Enquete de satisfaction trimestrielle",conformite:'Score >= 7/10',worst:'red'}
];

const globalWheelData=['green','orange','red','yellow','grey','yellow','orange'];
const categoryWheelData=['green','green','red','yellow','grey','grey','yellow'];

// 3-layer indicator data for ITR_QUAL_REF_TECH
const indData=[
    {global:{color:null,comment:''},categorie:{color:null,comment:''},indicateur:{color:'green',comment:''}},
    {global:{color:null,comment:''},categorie:{color:null,comment:''},indicateur:{color:'orange',comment:"Pas d'appareil de mesure\ndedie. Calcul manuel."}},
    {global:{color:'red',comment:"Blocage acces BDD\npour tous les indicateurs"},categorie:{color:null,comment:''},indicateur:{color:'orange',comment:"Mesures dans fichiers Excel.\nReferentiels a fournir."}},
    {global:{color:null,comment:''},categorie:{color:'yellow',comment:"Outils de preparation\nen cours de deploiement"},indicateur:{color:null,comment:''}},
    {global:{color:null,comment:''},categorie:{color:null,comment:''},indicateur:{color:'grey',comment:''}},
    {global:{color:null,comment:''},categorie:{color:null,comment:''},indicateur:{color:'yellow',comment:''}},
    {global:{color:null,comment:''},categorie:{color:'orange',comment:"Chantier patrimoine\ndocumentaire en cours"},indicateur:{color:'orange',comment:"Voir dates avec equipe.\nPlanification a affiner."}}
];

function worstColor(sd){
    const o={grey:0,green:1,yellow:2,orange:3,red:4}; let w=-1,wc='grey';
    ['global','categorie','indicateur'].forEach(k=>{const c=sd[k].color;if(c&&o[c]>w){w=o[c];wc=c;}});return wc;
}
function layerComments(sd){
    const r=[];['global','categorie','indicateur'].forEach(k=>{const d=sd[k];if(d.comment)r.push({key:k,badge:LAYERS[k].b,bc:LAYERS[k].c,lines:d.comment.split('\n')});});return r;
}

// ===================== SVG =====================
const svgNS='http://www.w3.org/2000/svg';
function mk(t){return document.createElementNS(svgNS,t);}

function drawSimpleWheel(id,data,opts={}){
    const svg=document.getElementById(id);svg.innerHTML='';
    const cx=220,cy=220,R=155,rx=48,ry=33,sa=-90;
    const defs=mk('defs');defs.innerHTML=`<marker id="a-${id}" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#3a7bd5"/></marker>`;svg.appendChild(defs);
    const pos=[];for(let i=0;i<7;i++){const a=(sa+i*360/7)*Math.PI/180;pos.push({x:cx+R*Math.cos(a),y:cy+R*Math.sin(a)});}
    for(let i=0;i<7;i++){const a1=(sa+i*360/7+19)*Math.PI/180,a2=(sa+(i+1)*360/7-19)*Math.PI/180;const p=mk('path');p.setAttribute('d',`M${cx+R*Math.cos(a1)} ${cy+R*Math.sin(a1)} A${R} ${R} 0 0 1 ${cx+R*Math.cos(a2)} ${cy+R*Math.sin(a2)}`);p.setAttribute('class','arrow-path');p.setAttribute('marker-end',`url(#a-${id})`);svg.appendChild(p);}
    for(let i=0;i<7;i++){
        const g=mk('g');g.setAttribute('class','step-ellipse');
        const ti=mk('title');ti.textContent=STEPS[i].short+': '+STEPS[i].tip;g.appendChild(ti);
        if(opts.onClick)g.onclick=(()=>{const idx=i;return()=>opts.onClick(idx);})();
        const el=mk('ellipse');el.setAttribute('cx',pos[i].x);el.setAttribute('cy',pos[i].y);el.setAttribute('rx',rx);el.setAttribute('ry',ry);el.setAttribute('fill',COL[data[i]]);el.setAttribute('stroke','rgba(255,255,255,0.12)');el.setAttribute('stroke-width','2');g.appendChild(el);
        const lines=STEPS[i].label.split('\n');const txt=mk('text');txt.setAttribute('class','step-label');txt.setAttribute('x',pos[i].x);txt.setAttribute('y',pos[i].y-(lines.length-1)*7);
        lines.forEach((l,li)=>{const ts=mk('tspan');ts.setAttribute('x',pos[i].x);ts.setAttribute('dy',li?'14':'0');ts.textContent=l;txt.appendChild(ts);});
        g.appendChild(txt);svg.appendChild(g);
    }
    if(opts.c1){const t=mk('text');t.setAttribute('class','center-title');t.setAttribute('x',cx);t.setAttribute('y',cy-8);t.textContent=opts.c1;svg.appendChild(t);}
    if(opts.c2){const t=mk('text');t.setAttribute('class','center-date');t.setAttribute('x',cx);t.setAttribute('y',cy+14);t.textContent=opts.c2;svg.appendChild(t);}
}

function drawIndWheel(){
    const svg=document.getElementById('wheel-indicator');svg.innerHTML='';
    const cx=370,cy=245,R=150,rx=48,ry=33,sa=-90;
    const defs=mk('defs');defs.innerHTML=`<marker id="a-ind" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto"><polygon points="0 0,10 3.5,0 7" fill="#3a7bd5"/></marker>`;svg.appendChild(defs);
    const pos=[];for(let i=0;i<7;i++){const a=(sa+i*360/7)*Math.PI/180;pos.push({x:cx+R*Math.cos(a),y:cy+R*Math.sin(a)});}
    for(let i=0;i<7;i++){const a1=(sa+i*360/7+19)*Math.PI/180,a2=(sa+(i+1)*360/7-19)*Math.PI/180;const p=mk('path');p.setAttribute('d',`M${cx+R*Math.cos(a1)} ${cy+R*Math.sin(a1)} A${R} ${R} 0 0 1 ${cx+R*Math.cos(a2)} ${cy+R*Math.sin(a2)}`);p.setAttribute('class','arrow-path');p.setAttribute('marker-end','url(#a-ind)');svg.appendChild(p);}
    // Comment slots
    const slotDefs={6:{x:4,w:165,s:'left'},5:{x:4,w:165,s:'left'},0:{x:4,w:165,s:'left'},1:{x:590,w:165,s:'right'},2:{x:590,w:165,s:'right'},3:{x:590,w:165,s:'right'}};
    function calcH(si){const ls=layerComments(indData[si]);if(!ls.length)return 0;let h=16;ls.forEach((l,i)=>{h+=14;h+=(l.lines.length-1)*12;if(i<ls.length-1)h+=3;});return h+6;}
    function posSlots(list){let y=8;const r=[];list.forEach(si=>{const h=calcH(si);if(h>0){r.push({si,y,h});y+=h+8;}});return r;}
    const allSlots=[...posSlots([6,5,0]),...posSlots([1,2,3])];
    allSlots.forEach(slot=>{
        const si=slot.si,sd=slotDefs[si];if(!sd)return;
        const ls=layerComments(indData[si]);if(!ls.length)return;
        const bx=sd.x,by=slot.y,bw=sd.w,bh=slot.h;
        const ln=mk('line');const ax=sd.s==='left'?bx+bw:bx;ln.setAttribute('x1',ax);ln.setAttribute('y1',by+bh/2);ln.setAttribute('x2',pos[si].x);ln.setAttribute('y2',pos[si].y);ln.setAttribute('class','comment-line');svg.appendChild(ln);
        const grp=mk('g');grp.style.cursor='pointer';
        const tps=[];ls.forEach(l=>tps.push('['+l.badge+'] '+l.lines.join(' ')));
        const gt=mk('title');gt.textContent=STEPS[si].short+'\n'+tps.join('\n');grp.appendChild(gt);
        const r=mk('rect');r.setAttribute('x',bx);r.setAttribute('y',by);r.setAttribute('width',bw);r.setAttribute('height',bh);r.setAttribute('class','comment-box-bg');r.setAttribute('rx','5');grp.appendChild(r);
        const wc=worstColor(indData[si]);const bar=mk('rect');bar.setAttribute('x',bx);bar.setAttribute('y',by);bar.setAttribute('width',3);bar.setAttribute('height',bh);bar.setAttribute('fill',COL[wc]);bar.setAttribute('rx','1');grp.appendChild(bar);
        const sl=mk('text');sl.setAttribute('class','comment-step-label');sl.setAttribute('x',bx+10);sl.setAttribute('y',by+12);sl.textContent=STEPS[si].short;grp.appendChild(sl);
        let cy2=by+24;const maxL=Math.floor((bw-34)/5.5);
        ls.forEach(layer=>{
            const br2=mk('rect');br2.setAttribute('x',bx+8);br2.setAttribute('y',cy2-9);br2.setAttribute('width',15);br2.setAttribute('height',12);br2.setAttribute('rx','2');br2.setAttribute('fill',layer.bc);grp.appendChild(br2);
            const bt=mk('text');bt.setAttribute('class','comment-badge-text');bt.setAttribute('x',bx+15.5);bt.setAttribute('y',cy2-3);bt.textContent=layer.badge;grp.appendChild(bt);
            layer.lines.forEach((line,j)=>{
                const tx=mk('text');tx.setAttribute('class','comment-text');tx.setAttribute('x',bx+27);tx.setAttribute('y',cy2);
                tx.textContent=line.length>maxL?line.substring(0,maxL-2)+'..':line;grp.appendChild(tx);cy2+=12;
            });
            cy2+=3;
        });
        svg.appendChild(grp);
    });
    // Ellipses
    for(let i=0;i<7;i++){
        const wc=worstColor(indData[i]);const g=mk('g');g.setAttribute('class','step-ellipse');
        const ti=mk('title');ti.textContent=STEPS[i].short+': '+STEPS[i].tip;g.appendChild(ti);
        const el=mk('ellipse');el.setAttribute('cx',pos[i].x);el.setAttribute('cy',pos[i].y);el.setAttribute('rx',rx);el.setAttribute('ry',ry);el.setAttribute('fill',COL[wc]);el.setAttribute('stroke','rgba(255,255,255,0.12)');el.setAttribute('stroke-width','2');g.appendChild(el);
        const lines=STEPS[i].label.split('\n');const txt=mk('text');txt.setAttribute('class','step-label');txt.setAttribute('x',pos[i].x);txt.setAttribute('y',pos[i].y-(lines.length-1)*7);
        lines.forEach((l,li)=>{const ts=mk('tspan');ts.setAttribute('x',pos[i].x);ts.setAttribute('dy',li?'14':'0');ts.textContent=l;txt.appendChild(ts);});
        g.appendChild(txt);svg.appendChild(g);
    }
    const ct=mk('text');ct.setAttribute('class','center-title');ct.setAttribute('x',cx);ct.setAttribute('y',cy-6);ct.textContent='ITR_QUAL_REF_TECH';svg.appendChild(ct);
    const cd=mk('text');cd.setAttribute('class','center-date');cd.setAttribute('x',cx);cd.setAttribute('y',cy+14);cd.textContent='16/02/2026';svg.appendChild(cd);
}

// ===================== INLINE COUNTERS =====================
function updateCounters(){
    const el=document.getElementById('inline-counters');
    const counts=[
        {c:'green',n:12,l:'Conformes'},{c:'yellow',n:18,l:'En cours'},{c:'orange',n:9,l:'Warning'},
        {c:'red',n:3,l:'Blocage'},{c:'grey',n:7,l:'Non eval.'}
    ];
    el.innerHTML=counts.map(x=>`<span class="ic" title="${x.l}"><span class="ic-dot" style="background:${COL[x.c]}"></span>${x.n}</span>`).join('');
}

// ===================== STATUS PANELS =====================
function buildSP(id,counts){
    const el=document.getElementById(id);
    el.innerHTML=['green','yellow','orange','red','grey'].map(c=>
        `<div class="status-filter-item"><span class="sf-dot" style="background:${COL[c]}"></span><span class="sf-label">${COL_L[c]}</span><span class="sf-count">${counts[c]||0}</span></div>`
    ).join('');
}

// ===================== FICHE PANEL =====================
function showFiche(code){
    const ind=INDICATORS.find(i=>i.code===code);if(!ind)return;
    const panel=document.getElementById('fiche-panel');
    const typeClass=ind.type==='SLA'?'fb-sla':ind.type==='KPI'?'fb-kpi':'fb-xla';
    document.getElementById('fiche-inner').innerHTML=`
        <div class="fiche-title">${ind.code}</div>
        <div class="fiche-desc">${ind.desc}</div>
        <div class="fiche-badges">
            <span class="fiche-badge ${typeClass}">${ind.type}</span>
            <span class="fiche-badge fb-etat">${ind.etat}</span>
            <span class="fiche-badge" style="background:${COL[ind.worst]}20;color:${COL[ind.worst]};border:1px solid ${COL[ind.worst]}40">${COL_L[ind.worst]}</span>
        </div>
        <div class="fiche-field"><label>Chapitre</label><div class="val">${ind.chap}</div></div>
        <div class="fiche-field"><label>Categorie</label><div class="val">${ind.cat}</div></div>
        <div class="fiche-field">
            <label>Condition de ciblage</label>
            <div class="val-box">${ind.ciblage}</div>
            <span class="fiche-edit">Modifier</span>
        </div>
        <div class="fiche-field">
            <label>Condition de conformite</label>
            <div class="val-box">${ind.conformite}</div>
            <span class="fiche-edit">Modifier</span>
        </div>
        <div class="fiche-actions-link" onclick="alert('Navigation vers le Kanban de ${ind.code}')">
            Actions (Kanban) &rsaquo;
        </div>
    `;
    panel.classList.add('visible');
}
function hideFiche(){
    document.getElementById('fiche-panel').classList.remove('visible');
}

// ===================== SIDEBAR =====================
let currentView='global', currentSection='roue';
function buildSidebar(){
    const sb=document.getElementById('sidebar');let h='';
    if(currentSection==='referentiel'){
        h+='<div class="sidebar-section"><h4>Filtres rapides</h4>';
        h+='<div class="sidebar-item active" onclick="qfCat(this,\'all\')"><span style="color:#888">Tous</span><span class="sidebar-count">'+INDICATORS.length+'</span></div>';
        CATEGORIES.forEach(c=>{const n=INDICATORS.filter(i=>i.cat===c.name).length;
            h+=`<div class="sidebar-item" onclick="qfCat(this,'${c.name}')"><span class="sidebar-dot" style="background:${COL[c.worst]}"></span><span>${c.name}</span><span class="sidebar-count">${n}</span></div>`;
        });h+='</div>';
    } else {
        h+='<div class="sidebar-section"><h4>Categories</h4>';
        CATEGORIES.forEach(c=>{
            h+=`<div class="sidebar-item" onclick="navCategory('${c.name}')" title="${c.name}"><span class="sidebar-dot" style="background:${COL[c.worst]}"></span><span>${c.name}</span><span class="sidebar-count">${c.count}</span></div>`;
        });
        h+='</div><div class="sidebar-divider"></div><div class="sidebar-section"><h4>Indicateurs</h4>';
        INDICATORS.forEach(ind=>{
            const cls=currentView==='indicator'&&ind.code==='ITR_QUAL_REF_TECH'?' active':'';
            h+=`<div class="sidebar-item${cls}" onclick="navIndicator('${ind.code}')" title="${ind.code} : ${ind.desc}"><span class="sidebar-dot" style="background:${COL[ind.worst]}"></span><span style="font-size:10px">${ind.code}</span></div>`;
        });
        h+='</div>';
    }
    sb.innerHTML=h;
}

// ===================== NAVIGATION =====================
function navGlobal(){
    currentView='global';hideFiche();
    ['view-global','view-category','view-indicator'].forEach(v=>document.getElementById(v).style.display=v==='view-global'?'':'none');
    document.getElementById('global-drill').style.display='none';
    document.getElementById('breadcrumb').innerHTML='<span class="current">Vue Globale</span>';
    buildSidebar();
}
function navCategory(name){
    currentView='category';hideFiche();
    ['view-global','view-category','view-indicator'].forEach(v=>document.getElementById(v).style.display=v==='view-category'?'':'none');
    document.getElementById('cat-title').textContent=name;
    document.getElementById('cat-drill').style.display='none';
    document.getElementById('breadcrumb').innerHTML='<a onclick="navGlobal()">Global</a><span class="sep"> &rsaquo; </span><span class="current">'+name+'</span>';
    buildSidebar();
}
function navIndicator(code){
    currentView='indicator';
    const ind=INDICATORS.find(i=>i.code===code);if(!ind)return;
    ['view-global','view-category','view-indicator'].forEach(v=>document.getElementById(v).style.display=v==='view-indicator'?'':'none');
    document.getElementById('ind-title').textContent=ind.code;
    document.getElementById('ind-subtitle').textContent=ind.desc;
    document.getElementById('breadcrumb').innerHTML='<a onclick="navGlobal()">Global</a><span class="sep"> &rsaquo; </span><a onclick="navCategory(\''+ind.cat+'\')">'+ind.cat+'</a><span class="sep"> &rsaquo; </span><span class="current">'+ind.code+'</span>';
    showFiche(code);
    drawIndWheel();
    const ic={grey:0,green:0,yellow:0,orange:0,red:0};indData.forEach(d=>ic[worstColor(d)]++);
    buildSP('sp-indicator',ic);
    buildSidebar();
}

// ===================== DRILL =====================
function showGlobalDrill(i){
    document.getElementById('global-drill-title').textContent='Etape : '+STEPS[i].short;
    const b=document.getElementById('global-drill-body');b.innerHTML='';
    CATEGORIES.forEach(c=>{const tr=document.createElement('tr');tr.onclick=()=>navCategory(c.name);tr.innerHTML=`<td>${c.name}</td><td><span class="status-dot" style="background:${COL[c.worst]}"></span>${COL_L[c.worst]}</td><td>${c.count}</td>`;b.appendChild(tr);});
    document.getElementById('global-drill').style.display='block';
}
function showCatDrill(i){
    document.getElementById('cat-drill-title').textContent='Etape : '+STEPS[i].short;
    const b=document.getElementById('cat-drill-body');b.innerHTML='';
    INDICATORS.filter(ind=>ind.cat==='Process Incident').forEach(ind=>{const tr=document.createElement('tr');tr.onclick=()=>navIndicator(ind.code);tr.innerHTML=`<td style="font-weight:600">${ind.code}</td><td>${ind.desc}</td><td><span class="status-dot" style="background:${COL[ind.worst]}"></span>${COL_L[ind.worst]}</td>`;b.appendChild(tr);});
    document.getElementById('cat-drill').style.display='block';
}

// ===================== SECTION SWITCH =====================
function switchSection(s){
    currentSection=s;
    document.querySelectorAll('.section').forEach(el=>el.classList.remove('active'));
    document.getElementById('section-'+s).classList.add('active');
    document.querySelectorAll('.main-tab').forEach(t=>t.classList.remove('active'));
    document.getElementById('tab-'+s).classList.add('active');
    if(s==='referentiel'){hideFiche();buildRefTable();updateRefStats();}
    else if(currentView==='indicator')showFiche('ITR_QUAL_REF_TECH');
    buildSidebar();
}

// ===================== REFERENTIEL =====================
function getFiltered(){
    const search=document.getElementById('ref-search').value.toLowerCase();
    const cat=document.getElementById('ref-cat-filter').value;
    const type=document.getElementById('ref-type-filter').value;
    const etat=document.getElementById('ref-etat-filter').value;
    return INDICATORS.filter(i=>{
        if(cat!=='all'&&i.cat!==cat)return false;if(type!=='all'&&i.type!==type)return false;
        if(etat!=='all'&&i.etat!==etat)return false;
        if(search&&!i.code.toLowerCase().includes(search)&&!i.desc.toLowerCase().includes(search))return false;
        return true;
    });
}
function buildRefTable(){
    const body=document.getElementById('ref-body');body.innerHTML='';
    getFiltered().forEach(ind=>{
        const tr=document.createElement('tr');
        const tc=ind.type==='SLA'?'type-sla':ind.type==='KPI'?'type-kpi':'type-xla';
        const ec=ind.etat==='Realise'?'etat-realise':ind.etat==='En cours'?'etat-encours':'etat-acadrer';
        tr.innerHTML=`<td><span class="status-dot" style="background:${COL[ind.worst]}"></span></td><td style="color:#888;font-size:11px">${ind.chap}</td><td style="font-weight:600;white-space:nowrap">${ind.code}</td><td>${ind.desc}</td><td style="color:#777;font-size:11px">${ind.cat}</td><td><span class="type-badge ${tc}">${ind.type}</span></td><td><span class="etat-badge ${ec}">${ind.etat}</span></td><td style="font-size:11px;color:#999;max-width:140px" title="${ind.ciblage}">${ind.ciblage.length>25?ind.ciblage.substring(0,23)+'...':ind.ciblage}</td><td style="font-size:11px;color:#999;max-width:140px" title="${ind.conformite}">${ind.conformite.length>25?ind.conformite.substring(0,23)+'...':ind.conformite}</td><td><span class="roue-link" onclick="event.stopPropagation();switchSection('roue');navIndicator('${ind.code}')">Roue</span></td>`;
        tr.onclick=()=>navIndicator(ind.code);
        body.appendChild(tr);
    });
}
function updateRefStats(){
    const f=getFiltered();const c={green:0,yellow:0,orange:0,red:0,grey:0};f.forEach(i=>c[i.worst]++);
    document.getElementById('ref-stats').innerHTML=
        `<span class="ref-stat"><span class="ic-dot" style="display:inline-block;width:7px;height:7px;border-radius:50%;background:${COL.green}"></span><span class="n">${c.green}</span> Conf.</span>`+
        `<span class="ref-stat"><span class="ic-dot" style="display:inline-block;width:7px;height:7px;border-radius:50%;background:${COL.yellow}"></span><span class="n">${c.yellow}</span> En cours</span>`+
        `<span class="ref-stat"><span class="ic-dot" style="display:inline-block;width:7px;height:7px;border-radius:50%;background:${COL.orange}"></span><span class="n">${c.orange}</span> Warn.</span>`+
        `<span class="ref-stat"><span class="ic-dot" style="display:inline-block;width:7px;height:7px;border-radius:50%;background:${COL.red}"></span><span class="n">${c.red}</span> Bloc.</span>`+
        `<span class="ref-stat"><span class="ic-dot" style="display:inline-block;width:7px;height:7px;border-radius:50%;background:${COL.grey}"></span><span class="n">${c.grey}</span> N/E</span>`+
        `<span class="ref-stat" style="margin-left:auto;color:#a0c4ff;font-weight:600">${f.length}/${INDICATORS.length}</span>`;
}
function filterRef(){buildRefTable();updateRefStats();}
function qfCat(el,cat){document.getElementById('ref-cat-filter').value=cat;filterRef();document.querySelectorAll('.sidebar-item').forEach(i=>i.classList.remove('active'));el.classList.add('active');}

// ===================== INIT =====================
// Populate category filter
const catSel=document.getElementById('ref-cat-filter');
CATEGORIES.forEach(c=>{const o=document.createElement('option');o.value=c.name;o.textContent=c.name;catSel.appendChild(o);});

drawSimpleWheel('wheel-global',globalWheelData,{c1:'VUE GLOBALE',c2:'49 indicateurs',onClick:showGlobalDrill});
drawSimpleWheel('wheel-category',categoryWheelData,{c1:'Process Incident',c2:'10 indicateurs',onClick:showCatDrill});
buildSP('sp-global',{green:12,yellow:18,orange:9,red:3,grey:7});
buildSP('sp-category',{green:5,yellow:2,orange:1,red:1,grey:1});
updateCounters();
buildSidebar();
buildRefTable();
updateRefStats();
</script>
</body>
</html>
